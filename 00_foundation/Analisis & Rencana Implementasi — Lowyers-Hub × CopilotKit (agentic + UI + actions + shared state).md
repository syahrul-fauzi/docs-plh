# Analisis & Rencana Implementasi — **Lowyers-Hub** × **CopilotKit (agentic + UI + actions + shared state)**

Berikut rancangan teknis terperinci (arsitektur, kontrak, contoh kode, testing, observabilitas, keamanan, dan langkah implementasi) untuk memenuhi semua poin yang Anda sebutkan. Saya mengacu pada dokumentasi CopilotKit untuk fitur inti: agentic chat UI, kustomisasi UI, suggestions, frontend/backend actions, dan shared-state. ([CopilotKit][1])

---

# 1) Ringkasan arsitektur tinggi

* **Client (Web/React, Ag-UI)**

  * Komponen chat (headless atau prebuilt) + composable UI components untuk messages, suggestions, generative panels.
  * Local state + connection ke *shared-state* (WS) untuk two-way sync.
* **API Gateway / Edge**

  * Auth (JWT/OPA), rate limiting, tenant routing (X-Tenant-ID), WAF.
* **Backend (Node + NestJS)**

  * *Agent orchestration service*: menampung sesi, konteks (conversation state), memanggil model/LLM/agent runtime, menjalankan backend actions.
  * *Actions service*: kumpulan backend actions terdaftar (DB ops, integrations).
  * *Suggestion engine*: real-time suggestions berdasarkan state & history.
  * *Shared state / Collaboration service*: Redis Streams / WebSocket pubsub untuk sinkronisasi UI ↔ agent.
* **Data plane & Integrations**

  * Multi-tenant DB schema (schema-per-tenant atau row-level tenant_id).
  * External connectors: whitelists, per-tenant credentials vault.
* **Observability & Security**

  * OpenTelemetry traces, Prometheus metrics, structured logs, audit trail (append-only).

Diagram (conceptual):
Client ←→ WebSocket (Shared State) ←→ Agent Orchestrator ←→ Backend Actions / LLM / External APIs

---

# 2) Desain komponen frontend — prinsip & kontrak

**Prinsip**: Headless-first, composable, type-safe (TypeScript), minimal side effects, predictable state transitions (finite state machine untuk conversation). Dokumentasi & prop types wajib.

**Komponen utama**:

1. `ChatContainer` (Headless wrapper) — init agent session, expose hooks.
2. `MessageList`, `MessageItem` — render markdown, attachments. (Gunakan markdown renderer CopilotKit jika tersedia). ([CopilotKit][2])
3. `Composer` — input, helpers, suggestion chips.
4. `GenerativePanel` — dynamic UI panels generated by agent. (Generative UI). ([CopilotKit][3])
5. `SuggestionsOverlay` — real-time suggestion UI surfaced from suggestion engine. ([CopilotKit][4])
6. `HumanInLoopModal` — UI for human verification/approval flows. ([CopilotKit][5])

**Kontrak data (TypeScript interfaces — contoh)**:

```ts
// shared-types.ts
export type TenantId = string;
export type SessionId = string;

export interface AgentMessage {
  id: string;
  sessionId: SessionId;
  author: 'agent' | 'user' | 'system';
  text?: string;
  markdown?: string;
  attachments?: Array<{type:string, url:string}>;
  timestamp: string;
  metadata?: Record<string, any>;
}

export interface Suggestion {
  id: string;
  label: string;
  actionId?: string; // frontend action id to trigger
  payload?: any;
  confidence?: number;
}
```

---

# 3) Shared State (dua arah) — arsitektur & mekanisme

* **Transport**: WebSocket (socket.io / Phoenix / ws) atau WebRTC datachannel untuk low latency.
* **State store**: Redis Streams or Redis + CRDT (untuk collaborative multi-client) — agent state persisted periodically to DB for audit.
* **Sync model**: optimistic local updates + authoritative server snapshots. Semua update difingerprint (version vector).
* **Event model**:

  * `client -> server`: `action.invoke`, `message.send`, `ui.update`
  * `server -> client`: `state.snapshot`, `state.patch`, `suggestions.update`, `approval.request`
* **Security**: setiap WS connection memuat JWT & tenant id; server memvalidasi scopes. ([CopilotKit][6])

---

# 4) Frontend actions (contoh implementasi)

**Gambaran**: frontend actions = fungsi yang dijalankan di browser (panggilan UI, local ops) atau memicu workflow ke backend.

Contoh `useFrontendActions` hook (React + TypeScript):

```tsx
// useFrontendActions.ts
import { useCallback } from "react";
import type { Suggestion } from "./shared-types";

export function useFrontendActions() {
  const triggerSuggestion = useCallback(async (s: Suggestion) => {
    if (s.actionId === 'open-document') {
      // open local modal, fetch doc via API
      window.open(`/tenant/doc/${s.payload.docId}`, '_blank');
    }
    if (s.actionId === 'run-quick-search') {
      // dispatch search event to parent state
      window.dispatchEvent(new CustomEvent('quick-search', { detail: s.payload }));
    }
    // else fallback: send to backend action
    if (s.actionId?.startsWith('backend:')) {
      await fetch('/api/actions/run', {
        method: 'POST',
        headers: {'content-type':'application/json'},
        body: JSON.stringify({ actionId: s.actionId.slice(8), payload: s.payload })
      });
    }
  }, []);
  return { triggerSuggestion };
}
```

Integrasi dengan CopilotKit suggestions UI: suggestions disediakan dari server via shared-state; klik chip memanggil `triggerSuggestion`.

Sumber: frontend actions doc. ([CopilotKit][7])

---

# 5) Backend actions (NestJS) — kontrak & contoh

**Kontrak**:

* Endpoint: `POST /api/actions/run`
* Headers: `Authorization: Bearer <jwt>`, `X-Tenant-ID: <tenant>`
* Body: `{ actionId: string, sessionId?: string, payload?: any }`
* Response: `{ status: 'ok'|'failed', result?: any, auditId?:string }`

**Contoh NestJS controller + service**:

```ts
// actions.controller.ts
import { Controller, Post, Body, Headers, UseGuards } from '@nestjs/common';
import { ActionsService } from './actions.service';

@Controller('actions')
export class ActionsController {
  constructor(private svc: ActionsService) {}

  @Post('run')
  async run(@Headers('x-tenant-id') tenant: string, @Body() body: any) {
    // validation + RBAC enforced in guards/middleware
    const res = await this.svc.execute(tenant, body.actionId, body.sessionId, body.payload);
    return res;
  }
}
```

```ts
// actions.service.ts (sketch)
export class ActionsService {
  async execute(tenant: string, actionId: string, sessionId?: string, payload?: any) {
    // lookup action registry
    const action = ACTION_REGISTRY[actionId];
    // permission check
    // run action (DB ops, external API, long-running job -> queue)
    const result = await action.run({tenant, sessionId, payload});
    // audit log
    await auditLog.save({tenant, sessionId, actionId, payload, result});
    return { status: 'ok', result };
  }
}
```

Gunakan queue (BullMQ) untuk long-running jobs; worker nodes menjalankan tindakan berat di luar request lifecycle. Dokumentasi backend actions CopilotKit relevan. ([CopilotKit][8])

---

# 6) Agent orchestration & context management

* **Session & Context**: persist conversation snapshot + short-term memory (in-memory + Redis) + long-term vector store (Milvus/PGVector) untuk retrieval.
* **Tooling**: agent runtime memanggil *backend actions* sebagai tools — actions terdaftar di registry dengan metadata (id, schema, scopes). Ini memastikan agent hanya mengeksekusi fungsi yang diizinkan. ([CopilotKit][1])
* **Human-in-the-loop**: define action types requiring approval (`approvalRequired: true`) -> server emits `approval.request` to clients; UI blocks or shows modal for explicit signoff. ([CopilotKit][5])

---

# 7) Copilot suggestions & personalization

* **Sumber saran**: real-time app state, session context, historical interactions, user preferences, telemetry signals. Implementasi:

  * Stream app events → suggestion service (rules + ML model) → rank suggestions → push to clients via shared-state. ([CopilotKit][4])
* **Personalization**: per-tenant models/weights; incremental learning from opt-in telemetry; fallback rules for new tenants.

---

# 8) UI customization / theming (kustom look & feel)

* **Mode pendekatan**:

  1. *Use built-in components & theme overrides* — cepat. ([CopilotKit][9])
  2. *Replace sub-components* — swap message renderer, composer, etc. ([CopilotKit][10])
  3. *Full headless approach* — implement UI dari nol, hanya konsumsi headless API/state. Ideal untuk brand-unique UI dan ag-UI. ([CopilotKit][11])
* **Markdown rendering**: gunakan renderer yang aman (sanitize + allowlist) untuk mencegah XSS; gunakan feature flags agar tenant dapat memilih mode rendering. ([CopilotKit][2])

---

# 9) Testing & QA

* **Unit tests**: Jest + ts-jest untuk services, reducers, hooks.
* **Integration tests**: spin up test DB (Postgres), Redis, and test orchestration flows (agent invokes action → DB mutation → audit).
* **E2E tests**: Playwright test untuk UI flows: message send, suggestion click, approval modal, generative panel rendering.
* **Agent behavior tests**: deterministic mock LLM responses for agent unit tests (mock tool calls).
* **Security tests**: automated SAST (ESLint, SonarCloud), dependency scanning, dynamic pen testing for endpoints that run actions.
* **Load tests**: k6 or Locust for WebSocket & core endpoints.

---

# 10) Observability & Monitoring

* **Traces**: OpenTelemetry across client (where possible), api gateway, backend services. Correlate traces by `sessionId` & `tenantId`.
* **Metrics**: Prometheus metrics for actions/sec, suggestion latency, ws connections per tenant.
* **Logging**: structured JSON logs (severity, tenant, sessionId, requestId). Retain audit logs separate (immutable).
* **Alerting**: error budget, latency SLOs, security events (suspicious action executions).

---

# 11) Security & Compliance (multi-tenant)

* **AuthZ/AuthN**: JWT + scopes, OIDC for SSO. RBAC for actions (who can approve, who can run sensitive actions).
* **Tenant isolation**: prefer schema-per-tenant or row-level with strict query policies + DB roles. Encrypt tenant keys in Vault (HashiCorp/Cloud KMS).
* **Input sanitization**: validate all action payloads via JSON Schema.
* **Auditability**: every action execution -> append audit record with actor, before/after snapshot, signature.
* **Data protection**: TLS in transit, AES-GCM at rest, rotate keys regularly. Comply with lokal regulation (Indonesia) re: data residency if required.

---

# 12) Performance considerations

* **Caching**: frontside caching for suggestions, LRU for recent contexts.
* **Batching**: group DB writes from actions where possible.
* **Backpressure**: queue long-running actions; return 202 for async where appropriate.
* **Scaling**: stateless backend + horizontal scaling; sticky sessions for WS using a pub/sub (Redis) or managed WS service.

---

# 13) Deliverables teknis (kode & docs)

* `packages/ag-ui/*` — headless chat primitives, prebuilt components, theme layers.
* `services/agent-orchestrator` — session manager, tool registry.
* `services/actions` — action registry + workers.
* `services/shared-state` — websocket gateway + redis sync.
* `infra/` — IaC (Terraform), k8s manifests, Helm, ingress/gw.
* `tests/` — unit, integration, e2e.
* `SECURITY.md`, `OPERATION.md`, `RUNBOOKS`, `API_SPEC.yaml` (OpenAPI).
* `docs/implementasi/*` — step-by-step deployment & tenant onboarding.

---

# 14) Contoh flow end-to-end (skenario)

1. User ketik permintaan di composer → client kirim message ke shared-state.
2. Agent Orchestrator terima event → update context → LLM generate rekomendasi + possible action `create_contract`.
3. Suggestion muncul di UI (chips). User klik → frontend action open modal (preview). Jika user confirm → frontend triggers backend action `create_contract` via `/api/actions/run`.
4. Backend actions service validasi, simpan ke DB, panggil external e-signature, hasil dikembalikan & audit diappend. UI update via shared-state snapshot.
5. Jika action sensitif, orchestration meminta human approval terlebih dahulu (`approval.request`). UI menampilkan HumanInLoop modal. ([CopilotKit][5])

---

# 15) Contoh snippet integrasi CopilotKit (pseudo, React + TS)

```tsx
// ChatPage.tsx (sketch)
import { useEffect } from 'react';
import { initAgentSession, onStatePatch, sendMessage } from 'copilotkit-headless';
import { MessageList, Composer, SuggestionsOverlay } from './components';

export function ChatPage() {
  useEffect(() => {
    const session = initAgentSession({ tenantId: TENANT, user: me });
    const unsub = onStatePatch((patch) => {
      // apply to local UI store
    });
    return () => { unsub(); session.close(); }
  }, []);

  return (
    <div className="chat-page">
      <MessageList />
      <SuggestionsOverlay />
      <Composer onSend={(text)=>sendMessage({text})} />
    </div>
  )
}
```

(Adaptasi headless API sesuai doc CopilotKit). ([CopilotKit][1])

---

# 16) Prioritas implementasi (phased)

* **Phase A — Foundation (must)**: headless chat session + shared-state, basic message flow, backend actions registry, auth/tenant routing, tests minimal.
* **Phase B — UX & Suggestions**: integrate suggestions engine, UI components, markdown rendering, human-in-the-loop modal.
* **Phase C — Generative UI & Customization**: generative panels, full themeing, allow tenant custom components.
* **Phase D — Hardening & Ops**: observability, scaling, security audit, compliance.
* **Phase E — Improve**: personalization ML, offline sync, advanced agent tooling.

---

# 17) Checklist dokumentasi & pengujian (singkat)

* [ ] OpenAPI untuk actions.
* [ ] JSON Schema untuk tiap action payload.
* [ ] Unit coverage > 80% untuk core services.
* [ ] E2E flows untuk: message→suggestion→action→approval.
* [ ] Run security scanner, dependency audit.

---

# 18) Hal teknis kritikal / keputusan yang perlu Anda setujui segera

* Pilih strategi tenant isolation: **schema-per-tenant** vs **row-level**. (mempengaruhi DB migrations & ops)
* Pilih LLM/agent runtime (hosted vs self-managed).
* Pilih apakah `suggestion model` akan dijalankan tenant-specific (lebih privat, lebih mahal) atau centrally.

---

Jika Anda mau, saya bisa:

* 1. Hasilkan **file `API_SPEC.yaml`** skeleton untuk `actions` + sample JSON Schema untuk 5 action umum (mis. create_contract, fetch_case, sign_doc).
* 2. Tulis **komponen React headless** yang siap di-copy ke `packages/ag-ui` (TypeScript + test).
* 3. Buat **skema DB multi-tenant** contoh (Postgres migration scripts).

Pilih salah satu (1 / 2 / 3) dan saya akan **langsung** hasilkan kode + spec yang bisa Anda pakai.

[1]: https://docs.copilotkit.ai/agentic-chat-ui "Agentic Chat UI"
[2]: https://docs.copilotkit.ai/custom-look-and-feel/markdown-rendering "Markdown rendering"
[3]: https://docs.copilotkit.ai/generative-ui "Generative UI"
[4]: https://docs.copilotkit.ai/copilot-suggestions "Copilot Suggestions"
[5]: https://docs.copilotkit.ai/human-in-the-loop "Human in the Loop (HITL)"
[6]: https://docs.copilotkit.ai/shared-state "Shared State"
[7]: https://docs.copilotkit.ai/frontend-actions "Frontend Actions"
[8]: https://docs.copilotkit.ai/backend-actions "Backend Actions"
[9]: https://docs.copilotkit.ai/custom-look-and-feel/built-in-ui-components "Prebuilt Copilot UI"
[10]: https://docs.copilotkit.ai/custom-look-and-feel/bring-your-own-components "Custom Sub-Components"
[11]: https://docs.copilotkit.ai/custom-look-and-feel/headless-ui "Fully Headless UI"